<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produce101 11人ピラミッドメーカー</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#121a2b;
      --panel2:#0f1626;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(80,120,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(160,90,255,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,26,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 0 6px;
    }
    h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    select, button{
      height:36px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(18,26,43,.9);
      color:var(--text);
      padding:0 12px;
      outline:none;
    }
    button{
      cursor:pointer;
      background: linear-gradient(180deg, rgba(40,120,255,.9), rgba(30,90,210,.9));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 8px 18px rgba(30,90,210,.25);
    }
    button:active{transform: translateY(1px)}
    main{max-width:1100px;margin:0 auto;padding:18px 16px 60px}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(18,26,43,.9), rgba(15,22,38,.92));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      user-select:none;
    }
    .card:hover{transform: translateY(-2px)}
    .thumb{
      aspect-ratio: 1 / 1;
      width:100%;
      background: rgba(255,255,255,.06);
      display:block;
      object-fit: cover;
    }
    .meta{padding:10px 10px 12px}
    .name{font-size:14px;font-weight:650;line-height:1.2;margin:0 0 6px}
    .sub{font-size:12px;color:var(--muted);margin:0}
    .card.selected{
      border-color: rgba(110,190,255,.85);
      filter: saturate(1.05);
      box-shadow: 0 0 0 2px rgba(110,190,255,.25), var(--shadow);
    }

    /* ピラミッド */
    .pyramidWrap{margin-top:18px}
    .pyramid{
      background: rgba(18,26,43,.65);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .row{
      display:flex;
      justify-content:center;
      gap:10px;
      margin:10px 0;
      flex-wrap:wrap;
    }
    .slot{
      width:86px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .slot img{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      display:block;
    }
    .slot .cap{
      padding:6px 8px 8px;
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hintBar{
      display:flex; align-items:center; justify-content:space-between;
      margin:0 0 10px; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:12px;
    }
    .miniBtns{display:flex; gap:8px; align-items:center}
    .mini{
      height:32px;
      padding:0 10px;
      border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .mini.primary{
      background: rgba(40,120,255,.22);
      border-color: rgba(40,120,255,.35);
    }

    @media (max-width:520px){
      .slot{width:78px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <h1>Produce101 11人ピラミッドメーカー</h1>
        <div class="controls">
          <select id="sort">
            <option value="registered">登録順</option>
            <option value="name_asc">名前 A→Z</option>
            <option value="name_desc">名前 Z→A</option>
          </select>
          <button id="reload" type="button">データ再読込</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="pyramidWrap">
      <div class="pyramid">
        <div class="hintBar">
          <div id="count"></div>
          <div class="miniBtns">
            <button class="mini" id="clear" type="button">全解除</button>
            <button class="mini primary" id="autoFill" type="button">ピラミッド反映</button>
          </div>
        </div>
        <div id="pyramid"></div>
      </div>
    </section>

    <section style="margin-top:16px">
      <div class="grid" id="grid"></div>
    </section>
  </main>

  <script>
    const CSV_PATH = "data/master.csv";
    const gridEl = document.getElementById("grid");
    const sortEl = document.getElementById("sort");
    const countEl = document.getElementById("count");
    const pyramidEl = document.getElementById("pyramid");

    const state = {
      people: [],
      selectedIds: new Set(),
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function splitCsvLine(line){
      const out = [];
      let cur = "";
      let inQ = false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '"'){
          if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if (c === "," && !inQ){
          out.push(cur); cur = "";
        } else {
          cur += c;
        }
      }
      out.push(cur);
      return out;
    }

    function parseCsv(text){
      const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l => l.trim() !== "");
      if (!lines.length) return [];
      const header = splitCsvLine(lines[0]).map(h => h.trim());
      const rows = [];
      for (let i=1;i<lines.length;i++){
        const cols = splitCsvLine(lines[i]);
        const obj = {};
        for (let j=0;j<header.length;j++){
          obj[header[j]] = (cols[j] ?? "").trim();
        }
        rows.push(obj);
      }
      return rows;
    }

    function normalizePeople(rows){
      return rows.map((r, idx) => {
        const id = r.id || r.ID || r.Id || String(idx+1);
        const name = r.name || r.Name || r.名前 || r.氏名 || "";
        const name_kana = r.kana || r.Kana || r.カナ || r.ふりがな || "";
        const img = r.img || r.image || r.Image || r.画像 || "";
        return { id, name, name_kana, img, __idx: idx };
      });
    }

    function setCountText(){
      const n = state.selectedIds.size;
      countEl.textContent = n ? `選択中：${n}` : "";
    }

    function getSortedPeople(){
      const arr = [...state.people];
      const mode = sortEl.value;
      if (mode === "registered"){
        arr.sort((a,b) => a.__idx - b.__idx);
      } else if (mode === "name_asc"){
        arr.sort((a,b) => (a.name || "").localeCompare(b.name || "", "ja"));
      } else if (mode === "name_desc"){
        arr.sort((a,b) => (b.name || "").localeCompare(a.name || "", "ja"));
      }
      return arr;
    }

    function renderGrid(){
      const arr = getSortedPeople();
      const html = arr.map(p => {
        const selected = state.selectedIds.has(p.id) ? "selected" : "";
        const imgSrc = p.img ? escapeHtml(p.img) : "";
        const name = escapeHtml(p.name || "");
        const sub = escapeHtml(p.name_kana || "");
        return `
          <div class="card ${selected}" data-id="${escapeHtml(p.id)}" role="button" tabindex="0" aria-label="${name}">
            <img class="thumb" src="${imgSrc}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend','<div style=&quot;aspect-ratio:1/1;background:rgba(255,255,255,.06);display:block&quot;></div>')" />
            <div class="meta">
              <p class="name">${name}</p>
              <p class="sub">${sub}</p>
            </div>
          </div>
        `;
      }).join("");
      gridEl.innerHTML = html;
      setCountText();
    }

    function toggleSelect(id){
      if (state.selectedIds.has(id)) state.selectedIds.delete(id);
      else state.selectedIds.add(id);
      renderGrid();
    }

    function renderPyramidFromSelection(){
      const picked = state.people.filter(p => state.selectedIds.has(p.id));
      const order = [1,2,3,5];
      const totalSlots = order.reduce((a,b)=>a+b,0);

      const slots = picked.slice(0, totalSlots);

      let cursor = 0;
      const rowsHtml = order.map(n => {
        const rowItems = [];
        for (let i=0;i<n;i++){
          const p = slots[cursor++];
          if (p){
            const imgSrc = p.img ? escapeHtml(p.img) : "";
            const name = escapeHtml(p.name || "");
            rowItems.push(`
              <div class="slot" title="${name}">
                <img src="${imgSrc}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.parentElement.style.background='rgba(255,255,255,.06)'" />
                <div class="cap">${name}</div>
              </div>
            `);
          } else {
            rowItems.push(`<div class="slot"><div style="aspect-ratio:1/1"></div><div class="cap"></div></div>`);
          }
        }
        return `<div class="row">${rowItems.join("")}</div>`;
      }).join("");

      pyramidEl.innerHTML = rowsHtml;
    }

    async function loadData(){
      const res = await fetch(CSV_PATH, { cache: "no-store" });
      const text = await res.text();
      const rows = parseCsv(text);
      state.people = normalizePeople(rows);
      state.selectedIds.clear();
      pyramidEl.innerHTML = "";
      renderGrid();
    }

    gridEl.addEventListener("click", (e) => {
      const card = e.target.closest(".card");
      if (!card) return;
      toggleSelect(card.dataset.id);
    });

    gridEl.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      const card = e.target.closest(".card");
      if (!card) return;
      e.preventDefault();
      toggleSelect(card.dataset.id);
    });

    sortEl.addEventListener("change", renderGrid);

    document.getElementById("reload").addEventListener("click", loadData);
    document.getElementById("clear").addEventListener("click", () => {
      state.selectedIds.clear();
      pyramidEl.innerHTML = "";
      renderGrid();
    });
    document.getElementById("autoFill").addEventListener("click", renderPyramidFromSelection);

    loadData();
  </script>
</body>
</html>
